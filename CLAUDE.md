# CLAUDE.md

This file provides comprehensive context and guidance for Claude Code when working with this Chrome Extension project.

---

## Project Overview

**PDF to Google Sheets Extension** - Chrome browser extension (Manifest V3) that converts PDF tables to Google Sheets, Excel, or CSV format.

**Key Features:**
- üìÑ Extract tables from text-based PDFs
- üìä Export to Google Sheets (via Drive API)
- üìÅ Download as Excel (.xlsx)
- üìÑ Download as CSV
- üé® Modern drag-and-drop UI
- ‚ö° Offscreen Document for optimal performance

**Technology Stack:**
- Manifest V3 (Chrome Extension standard)
- TypeScript
- Vite + @crxjs/vite-plugin (build tool)
- PDF.js v4.8 (PDF parsing)
- SheetJS v0.18 (Excel generation)
- Google Drive/Sheets API

---

## Project Structure

```
pdf-to-google-sheets/
‚îú‚îÄ‚îÄ .git/                      # Git repository
‚îú‚îÄ‚îÄ .gitignore                 # Git ignore rules
‚îú‚îÄ‚îÄ CLAUDE.md                  # THIS FILE - context for Claude Code
‚îú‚îÄ‚îÄ README.md                  # User-facing documentation
‚îú‚îÄ‚îÄ DEVELOPMENT_LOG.md         # Development progress tracking
‚îú‚îÄ‚îÄ TEST_SPEC.md               # Test specifications (not implemented yet)
‚îÇ
‚îú‚îÄ‚îÄ manifest.json              # Chrome Extension manifest (MV3)
‚îú‚îÄ‚îÄ package.json               # NPM dependencies
‚îú‚îÄ‚îÄ tsconfig.json              # TypeScript configuration
‚îú‚îÄ‚îÄ vite.config.ts             # Vite build configuration
‚îÇ
‚îú‚îÄ‚îÄ src/                       # Source code (TypeScript)
‚îÇ   ‚îú‚îÄ‚îÄ background/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ service-worker.ts  # Background service worker
‚îÇ   ‚îú‚îÄ‚îÄ popup/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ popup.html         # Popup UI
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ popup.css          # Popup styles
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ popup.ts           # Popup logic
‚îÇ   ‚îú‚îÄ‚îÄ offscreen/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ offscreen.html     # Offscreen document
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ offscreen.ts       # PDF processing & Excel generation
‚îÇ   ‚îú‚îÄ‚îÄ lib/                   # Future: shared utilities
‚îÇ   ‚îî‚îÄ‚îÄ types/                 # Future: TypeScript definitions
‚îÇ
‚îú‚îÄ‚îÄ public/
‚îÇ   ‚îî‚îÄ‚îÄ pdf.worker.min.js      # PDF.js worker (1.4MB)
‚îÇ
‚îú‚îÄ‚îÄ dist/                      # Built extension (generated by Vite)
‚îÇ   ‚îú‚îÄ‚îÄ manifest.json          # Compiled manifest
‚îÇ   ‚îú‚îÄ‚îÄ assets/                # Compiled JS/CSS
‚îÇ   ‚îú‚îÄ‚îÄ src/                   # Compiled HTML
‚îÇ   ‚îî‚îÄ‚îÄ pdf.worker.min.js      # Copied worker
‚îÇ
‚îú‚îÄ‚îÄ input/                     # Research materials (from previous project)
‚îÇ   ‚îú‚îÄ‚îÄ compass_artifact...md  # Technical design document
‚îÇ   ‚îú‚îÄ‚îÄ summary.md             # Niche analysis
‚îÇ   ‚îî‚îÄ‚îÄ extensions/            # Competitor analysis
‚îÇ
‚îú‚îÄ‚îÄ demo.html                  # Standalone demo (with real PDF parsing!)
‚îú‚îÄ‚îÄ test.html                  # Simple UI test page
‚îú‚îÄ‚îÄ test-build.cjs             # Build verification script
‚îÇ
‚îî‚îÄ‚îÄ node_modules/              # NPM packages (gitignored)
```

---

## Quick Start

### First Time Setup

```bash
# Navigate to project
cd pdf-to-google-sheets

# Install dependencies
npm install

# Copy PDF.js worker (if not present)
cp node_modules/pdfjs-dist/build/pdf.worker.min.mjs public/pdf.worker.min.js
```

### Development Commands

```bash
# Start dev server (with HMR)
npm run dev

# Build for production
npm run build

# Run build verification tests
node test-build.cjs
```

### Testing in Chrome

1. Build the extension: `npm run build`
2. Open Chrome: `chrome://extensions`
3. Enable "Developer mode" (top right)
4. Click "Load unpacked"
5. Select the `dist/` folder
6. Extension appears in toolbar!

### Testing Demo Page

```bash
# Open demo.html in browser
# Has full PDF parsing functionality
# Works standalone without Chrome Extension APIs
```

---

## Architecture Details

### Manifest V3 Components

#### 1. **Service Worker** (`src/background/service-worker.ts`)
- Runs in background (event-driven, not persistent)
- Handles:
  - Google OAuth authentication (`chrome.identity.getAuthToken`)
  - File downloads (`chrome.downloads.download`)
  - Offscreen Document management
  - Message passing between popup and offscreen
- **IMPORTANT**: No DOM access, cannot use PDF.js directly

#### 2. **Popup** (`src/popup/popup.*`)
- Main user interface
- Features:
  - Drag & drop file upload
  - Progress tracking
  - Data preview (first 10 rows)
  - Export buttons
- Sends messages to Service Worker for processing

#### 3. **Offscreen Document** (`src/offscreen/offscreen.*`)
- Hidden document with DOM access
- Reasons: `DOM_PARSER`, `WORKERS`
- Handles:
  - PDF.js initialization and parsing
  - Table extraction from text coordinates
  - Excel file generation with SheetJS
- Created on-demand by Service Worker

### Message Flow

```
User uploads PDF in Popup
    ‚Üì
Popup ‚Üí Service Worker: { action: 'processPdf', data: ArrayBuffer }
    ‚Üì
Service Worker ‚Üí Offscreen: { target: 'offscreen', action: 'parsePdf' }
    ‚Üì
Offscreen processes PDF with PDF.js
    ‚Üì
Offscreen ‚Üí Service Worker: { success: true, tables: string[][] }
    ‚Üì
Service Worker ‚Üí Popup: { success: true, tables: string[][] }
    ‚Üì
Popup displays preview and export buttons
```

---

## Key Algorithms

### Table Extraction Algorithm

Located in `src/offscreen/offscreen.ts` and `demo.html`

**How it works:**

1. **PDF.js Parsing**
   ```javascript
   const textContent = await page.getTextContent();
   // Returns array of text items with coordinates
   ```

2. **Coordinate Extraction**
   ```javascript
   items = textContent.items.map(item => ({
     text: item.str,
     x: item.transform[4],        // X position
     y: viewport.height - item.transform[5],  // Y position (flipped)
     width: item.width,
     height: item.transform[0]
   }));
   ```

3. **Row Grouping** (Y-axis clustering)
   ```javascript
   const rowThreshold = 5; // pixels
   // Group items with Y difference < 5px into same row
   ```

4. **Column Detection** (X-axis analysis)
   ```javascript
   const colThreshold = 10; // pixels
   // Detect unique X positions as column boundaries
   ```

5. **Cell Assignment**
   ```javascript
   // Find closest column for each text item
   // Merge multiple text items in same cell with space
   ```

**Thresholds:**
- `rowThreshold: 5px` - Max Y difference for same row
- `colThreshold: 10px` - Min X difference for different column
- **Adjustable** for different PDF layouts!

---

## Data Types & Validation

### Core Data Structure

```typescript
// Table data is always 2D array of strings
type TableData = string[][];

// Example:
const exportedData: TableData = [
  ['Name', 'Email', 'Phone'],        // Header row
  ['John', 'john@example.com', '555-0123'],
  ['Jane', 'jane@example.com', '555-0456']
];
```

### Validation Rules (See TEST_SPEC.md)

1. **Type**: Must be `Array<Array<string>>`
2. **Consistency**: All rows must have same column count
3. **Sanitization**: Null/undefined ‚Üí empty string
4. **Escaping**: Commas and quotes in CSV export

---

## Google API Configuration

### Required APIs
- Google Drive API
- Google Sheets API

### OAuth Scopes
```json
{
  "scopes": [
    "https://www.googleapis.com/auth/drive.file",
    "https://www.googleapis.com/auth/spreadsheets"
  ]
}
```

**Note:** `drive.file` scope does NOT require Google Security Assessment (unlike `drive` scope)

### Setup Steps (Not Yet Done)

1. Go to [Google Cloud Console](https://console.cloud.google.com/)
2. Create new project
3. Enable APIs: Drive + Sheets
4. Create OAuth 2.0 Client ID:
   - Type: Chrome Extension
   - Extension ID: Get from `chrome://extensions` in dev mode
5. Update `manifest.json`:
   ```json
   "oauth2": {
     "client_id": "YOUR_CLIENT_ID.apps.googleusercontent.com",
     "scopes": [...]
   }
   ```

---

## Build System

### Vite + CRXJS

**Why Vite?**
- Fast HMR (Hot Module Replacement)
- ES modules support
- TypeScript out of the box
- Optimized production builds

**Why CRXJS?**
- Chrome Extension-specific Vite plugin
- Handles Manifest V3 complexities
- Auto-reloads extension on code changes
- Transforms TS imports in manifest

### Build Output

```
dist/
‚îú‚îÄ‚îÄ manifest.json              # Transformed from src
‚îú‚îÄ‚îÄ service-worker-loader.js   # CRXJS-generated loader
‚îú‚îÄ‚îÄ assets/
‚îÇ   ‚îú‚îÄ‚îÄ popup-*.js             # Compiled popup code
‚îÇ   ‚îú‚îÄ‚îÄ popup-*.css            # Compiled styles
‚îÇ   ‚îú‚îÄ‚îÄ offscreen-*.js         # Compiled offscreen code
‚îÇ   ‚îî‚îÄ‚îÄ service-worker.ts-*.js # Compiled background script
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ popup/popup.html       # Copied HTML
‚îÇ   ‚îî‚îÄ‚îÄ offscreen/offscreen.html
‚îî‚îÄ‚îÄ pdf.worker.min.js          # Copied from public/
```

---

## Common Development Tasks

### Add New Feature

1. **Plan architecture** (create task list with TodoWrite)
2. **Update relevant files**:
   - `src/popup/` for UI changes
   - `src/background/` for API calls
   - `src/offscreen/` for heavy processing
3. **Test in dev mode**: `npm run dev` ‚Üí load in Chrome
4. **Update DEVELOPMENT_LOG.md**
5. **Commit with proper message format**

### Debug Issues

**Popup Issues:**
- Right-click extension icon ‚Üí "Inspect popup"
- Console logs visible in DevTools

**Service Worker Issues:**
- `chrome://extensions` ‚Üí Click "service worker" link
- Console logs appear in new DevTools window

**Offscreen Document Issues:**
- `chrome://extensions` ‚Üí "Inspect views: offscreen.html"
- Check console for PDF.js errors

### Update Dependencies

```bash
# Check for updates
npm outdated

# Update specific package
npm install pdfjs-dist@latest

# Update all (risky!)
npm update
```

---

## OCR Integration (Future)

### Architecture for OCR

Already implemented in `demo.html`:

```javascript
const ExtractionMethod = {
  TEXT: 'text',      // Current: PDF.js text extraction
  OCR: 'ocr',        // Future: Tesseract.js
  HYBRID: 'hybrid'   // Future: Try text, fallback to OCR
};
```

### Implementation Plan

1. **Add Tesseract.js**:
   ```bash
   npm install tesseract.js
   ```

2. **Detect PDF type**:
   ```javascript
   async function detectPdfType(arrayBuffer) {
     const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
     const page = await pdf.getPage(1);
     const textContent = await page.getTextContent();

     if (textContent.items.length === 0) {
       return 'scanned'; // No text ‚Üí probably scanned
     }
     return 'text';
   }
   ```

3. **Implement OCR extraction**:
   ```javascript
   async function extractWithOcr(arrayBuffer) {
     // 1. Convert PDF page to image
     // 2. Run Tesseract.js
     // 3. Parse OCR output into table structure
     // 4. Return string[][]
   }
   ```

4. **Hybrid mode**:
   ```javascript
   async function parsePdf(arrayBuffer, method = 'hybrid') {
     if (method === 'hybrid') {
       try {
         const result = await parsePdfText(arrayBuffer);
         if (result.length > 0) return result;
       } catch (e) {
         // Fallback to OCR
       }
       return await extractWithOcr(arrayBuffer);
     }
   }
   ```

---

## Performance Considerations

### PDF.js Worker

- **Size**: 1.4MB (large!)
- **Loading**: Async via `workerSrc`
- **Memory**: Can spike for large PDFs
- **Solution**: Process pages sequentially, not all at once

### Large Tables

- **Preview limit**: Show only first 10 rows in UI
- **Full data**: Export all rows to file
- **Memory**: Clear `exportedData` on reset()

### Build Size

Current production build:
- `offscreen-*.js`: ~650KB (PDF.js + SheetJS)
- `popup-*.js`: ~5KB
- `service-worker-*.js`: ~3KB
- Total: ~660KB (acceptable for extension)

**Optimization ideas:**
- Code splitting (dynamic imports)
- Tree shaking (remove unused PDF.js features)
- Compression (already enabled in Vite)

---

## Testing Strategy

See `TEST_SPEC.md` for full specification.

**Current status**: Tests NOT implemented yet

**Quick test checklist:**
1. ‚úÖ Build verification: `node test-build.cjs`
2. ‚úÖ Demo page: Open `demo.html`, upload PDF
3. ‚è≠Ô∏è Unit tests: TBD
4. ‚è≠Ô∏è Integration tests: TBD

---

## Git Workflow

### Branch Naming

- `feature/` - New features
- `fix/` - Bug fixes
- `docs/` - Documentation only
- `refactor/` - Code refactoring

### Commit Message Format

```
<type>: <short description>

<detailed description>

<optional metadata>

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
```

**Types**: `feat`, `fix`, `docs`, `refactor`, `test`, `chore`

---

## Troubleshooting

### Common Issues

#### 1. "Could not resolve entry module"
**Problem**: TypeScript file referenced in `manifest.json`
**Solution**: CRXJS expects `.ts` extensions in manifest

#### 2. "pdf.worker.min.js not found"
**Problem**: Worker not copied to `public/`
**Solution**:
```bash
cp node_modules/pdfjs-dist/build/pdf.worker.min.mjs public/pdf.worker.min.js
```

#### 3. "Extension failed to load"
**Problem**: Syntax error in built files
**Solution**: Check console, rebuild with `npm run build`

#### 4. "No tables found in PDF"
**Problem**: PDF is scanned image or complex layout
**Solution**: Adjust thresholds in `extractTable()` or wait for OCR

#### 5. OAuth errors
**Problem**: Google Cloud not configured
**Solution**: See "Google API Configuration" section above

---

## TODO / Roadmap

### Immediate (Current Sprint)
- [x] Basic PDF parsing
- [x] Table extraction
- [x] Demo page with real parsing
- [x] Download CSV/Excel
- [ ] Test with real PDF files
- [ ] Fix edge cases in table detection

### Short-term (Next 2 weeks)
- [ ] Create extension icons (16x16, 48x48, 128x128)
- [ ] Configure Google Cloud OAuth
- [ ] Test Google Sheets export
- [ ] Improve error messages
- [ ] Add loading states

### Medium-term (Next month)
- [ ] Implement OCR for scanned PDFs (Tesseract.js)
- [ ] Add table selection tool (manual correction)
- [ ] Support multi-page tables
- [ ] Custom formatting options
- [ ] Settings page

### Long-term (Future)
- [ ] Batch processing (multiple PDFs)
- [ ] History of conversions
- [ ] Dark mode
- [ ] Export templates
- [ ] Chrome Web Store publication

---

## Important Notes for Claude Code

### When Starting a New Session

1. **Read this file first** (`CLAUDE.md`)
2. **Check `DEVELOPMENT_LOG.md`** for latest progress
3. **Review git status**: `git status` and `git log -5`
4. **Check todos**: Look at "TODO / Roadmap" above
5. **Ask user** what they want to work on

### Best Practices

1. **Always use TodoWrite** for tracking progress on complex tasks
2. **Update DEVELOPMENT_LOG.md** after significant changes
3. **Test changes**: `npm run build && node test-build.cjs`
4. **Commit frequently** with descriptive messages
5. **Keep types strict**: Validate `exportedData` is `string[][]`

### Code Style

- **TypeScript**: Use strict types
- **Async/await**: Prefer over promises
- **Error handling**: Always try/catch async functions
- **Comments**: Explain WHY, not WHAT
- **Naming**: Descriptive names (no `x`, `tmp`, `data1`)

### Files to NEVER Edit

- `node_modules/`
- `dist/` (auto-generated)
- `package-lock.json` (auto-generated)
- `.git/`

### Files to Always Update Together

- `manifest.json` + `vite.config.ts` (when adding new entry points)
- `package.json` + imports (when adding dependencies)
- `CLAUDE.md` + `DEVELOPMENT_LOG.md` (when major changes)

---

## Useful Commands

```bash
# Development
npm run dev              # Start dev server
npm run build            # Production build
node test-build.cjs      # Verify build

# Git
git status              # Check changes
git log -5              # Recent commits
git diff                # See changes

# Chrome Extension
chrome://extensions     # Extension management
chrome://inspect        # Debug tools

# Node
npm install             # Install deps
npm outdated            # Check updates
npm list --depth=0      # List top-level deps
```

---

## Resources

- [Chrome Extension Docs](https://developer.chrome.com/docs/extensions/mv3/)
- [PDF.js API](https://mozilla.github.io/pdf.js/api/)
- [SheetJS Docs](https://docs.sheetjs.com/)
- [Vite Docs](https://vitejs.dev/)
- [CRXJS Plugin](https://crxjs.dev/vite-plugin/)

---

## Contact / Maintenance

**Project Owner**: @egorchepiga
**Repository**: https://github.com/egorchepiga/pdf-to-google-sheets
**Created**: 2025-12-12
**Last Updated**: 2025-12-12

---

**Remember**: This is a working prototype. The goal is to validate the concept before investing in production-ready features like OCR, advanced error handling, and Chrome Web Store publication.
